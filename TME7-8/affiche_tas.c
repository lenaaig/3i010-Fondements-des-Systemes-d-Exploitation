#include <stdio.h>
#include "affiche_tas.h"
#include <ctype.h>
#include <string.h>

void afficher_tas(){
    int i, j;
    for (i = 0; i < 8; i++) {
        for (j = 0; j < 16; j++) { 
	    printf("%4d", j + 16*i);
        }
        printf("\n");
        for (j = 0; j < 16; j++) { 
	    printf("%4d", tas[j + 16*i]);
        }
        printf("\n");
        for (j = 0; j < 16; j++) { 
	    if (isalnum(tas[j + 16*i])) {
	        printf("%4c", tas[j + 16*i]);
	    } else {
		printf("    ");
	    }
        }
        printf("\n\n");
    }
    printf("---------------------------------------------------------------\n\n");
}


void tas_init(){
	libre = 0;
	tas[0] = TAILTAS;
	tas[1] = -1;
}

/*Strategie premier trouvÃ©, premier pris*/
/*@param: taille en octect et *pred l'adresse dans le debut du tas*/
/*@return: adresse debut de zone*/
int first_fit(int taille, int *pred){
	int p=libre;
	while(p!=-1 && tas[p]<taille){
		*pred=p;
		p=tas[p+1];
	}
	return p;
}


char* tas_malloc(int taille){
	int p, pred;
	p=first_fit(taille, &pred); //Adresse debut de zone libre

	//cas 1er malloc;
	if(p==libre){
		printf("cas 1er\n");
		tas[p]=taille;
		tas[p+1]= &tas[taille+1]; //adresse chainon suivant
		tas[p+taille+1]=TAILTAS-taille-1; //chainon suivant
		tas[p+taille+2]=-1;
		libre+=taille+1;
		return &tas[p+1];
	}
	//cas 1
	if (tas[p]-taille<=TAILMIN){
		printf("CAS 1: p=%d taille=%d pred=%d\n",p,taille,pred);
		tas[pred+1]=tas[p+1];
		return &tas[p+1];
	}
	//cas 2: lorsq'il y a des trous dans le tas
	else{
		printf("CAS 2: p=%d taille=%d pred=%d\n",p,taille,pred);
		tas[p+taille+1]=tas[p]-taille-1; //maj taille T'
		tas[p+taille+2]=tas[p+1]; //on va au chainon suivant
		tas[pred+1]+=taille+1;
		tas[p]=taille;
		return &tas[p+1];
	}
	
	return NULL;
}

void tas_free(char *ptr){
	ptr[0]=tas[libre];
	libre=
}


