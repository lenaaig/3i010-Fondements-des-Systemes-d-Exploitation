#include "fat.h"
#include <string.h>
#include <stdio.h>
#include <stdlib.h>

int file_found (char * file ) {
  int i;
  struct ent_dir * pt = pt_DIR;

  for (i=0; i< NB_DIR; i++) {
    if ((pt->del_flag) && (!strcmp (pt->name, file))) 
      return 0;
    pt++;
  }
  /* finchier n'existe pas */
  return 1;
}


void list_fat () {
  int i;
  short *pt = pt_FAT;
  for (i=0; i < NB_ENT_FAT; i++) {
    if (*pt)
      printf ("%d ",i);
    pt++;
  }
  printf ("\n");
}


void list_dir () {
	struct ent_dir * pt = pt_DIR;
	short *ptfat=pt_FAT;

	int i;
	int cpt=0;
  	for (i=0; i<NB_DIR; i++){
	  	if(pt->del_flag ==1){
	  		printf("%s de taille %d\n", pt->name , pt->size );
	  		cpt++;
	  		printf("%d, ", pt->first_bloc);
	  		short *j = ptfat + pt->first_bloc;
	  		//printf("j: %d\n",*j );
	  		while((*j) != -1){
	  			printf("%d, ",*j);
	  			j=ptfat+*j;
	  		}
	  		printf("\n");

	  	}
  	pt++;
	}


	printf("nombre total de fichiers du rep : %d\n",cpt);
}

int cat_file (char* file) {
	//Fichier n'existe pas 
	if(file_found(file) == 1) return -1;

	//Pointeur Repertoire
	struct ent_dir * pt = pt_DIR;	
	//Pointeur FAT
	short *ptfat= pt_FAT;
	char* buffer=(char*) malloc(sizeof(char*)*(SIZE_SECTOR));
	
	int i, c;
	for (i=0; i< NB_DIR; i++) {
		if ((pt->del_flag) && (!strcmp (pt->name, file))) 
		  break;
		pt++;
  	}
  	
  	short j = pt->first_bloc;
	while((j) != -1){
	  	printf("%d: ",j);
	  	c = read_sector((j),buffer);
	  	printf("%s\n",buffer);
	  	short *suiv = ptfat+j;
	  	j= *suiv;
	}
	printf("\nEnd of File\n");
	return c;
}

int mv_file (char*file1, char *file2) {
	struct ent_dir * pt = pt_DIR;	
	int i;
	for(i=0; i<NB_DIR; i++){
		if (strcmp(pt->name,file1)==0){
			strcpy(pt->name,file2);
			return write_DIR_FAT_sectors();
		}
		pt++;
	}
	return -1;
}

int delete_file (char* file){
	//Fichier n'existe pas 
	if(file_found(file) == 1) return -1;
	//Pointeur Repertoire
	struct ent_dir * pt = pt_DIR;	
	//Pointeur FAT
	short *ptfat= pt_FAT;
	
	int i;
	for (i=0; i< NB_DIR; i++) {
		if ((pt->del_flag) && (!strcmp (pt->name, file))) 
		  break;
		pt++;
  	}
  	
  	pt->del_flag=0; 
  	short *j = ptfat + pt->first_bloc;
	while((*j) != -1){
		short tmp=*j;
		*j=0;
	  	j = ptfat + tmp;
	}
	*j=0; //on change le -1 en 0
  	
  	write_DIR_FAT_sectors(); 
  	return 0;
}

int create_file (char *file) {
	//Fichier existe
  	if(file_found(file) == 0) return -1;
  	//Pointeur Repertoire
  	struct ent_dir * pt = pt_DIR;
	
	int i;
	for (i=0; i< NB_DIR; i++) {
		if (pt->del_flag == 0)
		  break;
		pt++;
  	} 
  	//Fin du repertoire
  	if(pt->del_flag == 1) return -1;
  	
  	pt->del_flag = 1;
  	strcpy(pt->name,file);
  	pt->size=0;
  	pt->first_bloc = FIN_FICHIER;
  	pt->last_bloc = FIN_FICHIER;
  	
  	
  	write_DIR_FAT_sectors(); 
  	return 0;
}


short alloc_bloc () { 
  	//Pointeur FAT
	short *ptfat= pt_FAT; 
	int i;
	for(i=0; i<NB_ENT_FAT; i++){
		if(*ptfat == 0)
			break;
		ptfat++; 
	}
	if((i==NB_ENT_FAT) || (*ptfat !=0)) return -1;
	
	*ptfat=FIN_FICHIER;
	return i;
}
 	
int append_file  (char*file, char *buffer, short size) { 
	//Fichier n'existe pas 
	if(file_found(file) == 1) return -1;
	//Pointeur Repertoire
	struct ent_dir * pt = pt_DIR;	
	//Pointeur FAT
	short *ptfat= pt_FAT;
	
	int i;
	for (i=0; i< NB_DIR; i++) {
		if ((pt->del_flag) && (!strcmp (pt->name, file))) 
		  break;
		pt++;
  	}
  	
  	short nbBloc = size/128;
  	short bloc;
  	short *tmp;
  	pt->size += nbBloc;
  	for(i=0; i<nbBloc; i++){
  		bloc = alloc_bloc();
  		if(bloc == -1) return -1;
  		
  		//Mise A Jour last_bloc et FAT
  		tmp = ptfat + pt->last_bloc;
  		*tmp=bloc;
  		pt->last_bloc = bloc;
  		
  		if(write_sector(bloc, buffer) == -1) return -1;
  		buffer= buffer+128;
  	}
	

 	write_DIR_FAT_sectors(); 
  	return 0;  
}


struct ent_dir*  read_dir (struct ent_dir *pt_ent ) {
  /* A COMPLETER */  
}




